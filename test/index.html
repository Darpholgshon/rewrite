<html>
  <head>
    <title>rewrite tests</title>
    <script src="static/jquery.js"></script>
    <link rel="stylesheet" 
      href="static/qunit.css" type="text/css" media="screen" />
    <script type="text/javascript"
      src="static/qunit.js"></script>
    <script type="text/javascript"
      src="static/rewrite-tests.js"></script>
    <script>
    $(document).ready(function(){
      module("root") ;
      asyncTest("simple root", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/', '<root>server#status</root>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/server.xqy?action=status', "OK" );
           }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("shouldn't match root", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/foo.jpg', 
            '<root>server#status</root>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/static/foo.jpg', "OK" );
           }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
        
      module("get") ;
      asyncTest("static get to", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/list', 
            '<get path="/list"> <to> article#list </to> </get>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/article.xqy?action=list', "OK" );
           }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
        
      module("put") ;
      asyncTest("static put to", function() {
        $.ajax( {
          url: rewriteUrl( 'PUT', '/upload', 
            '<put path="/upload"> <to> file#upload </to> </put>', '' )
        , type: 'PUT'
        , success:  function(d,t,j) { 
          equals( d, '/resource/file.xqy?action=upload', "OK" );
           }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      
      module("post") ;
      asyncTest("static post to", function() {
        $.ajax( {
          url: rewriteUrl( 'POST', '/upload', 
            '<post path="/upload"> <to> file#upload </to> </post>', '' )
        , type: 'POST'
        , success:  function(d,t,j) { 
          equals( d, '/resource/file.xqy?action=upload', "OK" );
           }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      
      module("delete") ;
      asyncTest("static delete to", function() {
        $.ajax( {
          url: rewriteUrl( 'DELETE', '/all-dbs', 
            '<delete path="/all-dbs"> <to> db#del </to> </delete>', '' )
        , type: 'DELETE'
        , success:  function(d,t,j) { 
          equals( d, '/resource/db.xqy?action=del', "OK" );
           }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      
      module("head") ;
      asyncTest("static head to", function() {
        $.ajax( {
          url: rewriteUrl( 'HEAD', '/', 
            '<head path="/"> <to> server#ping </to> </head>', '' )
        , type: 'GET' // head doesnt return body
        , success:  function(d,t,j) { 
          equals( d, '/resource/server.xqy?action=ping', "OK" );
           }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      
      module("complex") ;
      asyncTest("route should match with and without trailing /", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/list/', 
            '<get path="/list"> <to> article#list </to> </get>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/article.xqy?action=list', "OK" );
           }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      
      module("paths") ;
      asyncTest("Change resource directory to /controller/", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/', '<root>server#status</root>', '',
          '<resourceDirectory>/controller/</resourceDirectory>' )
        , success:  function(d,t,j) { 
          equals( d, '/controller/server.xqy?action=status', "OK" );
           }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("Change resource directory to /", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/', '<root>server#status</root>', '',
          '<resourceDirectory>/</resourceDirectory>' )
        , success:  function(d,t,j) { 
          equals( d, '/server.xqy?action=status', "OK" );
           }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("Change resource directory to ()", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/', '<root>server#status</root>', '',
          '<resourceDirectory/>' )
        , success:  function(d,t,j) { 
          equals( d, 'server.xqy?action=status', "OK" );
           }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("Change extension to .xq", function() {
         $.ajax( {
           url: rewriteUrl( 'GET', '/', '<root>server#status</root>', '',
           '<xqyExtension>xq</xqyExtension>' )
         , success:  function(d,t,j) { 
           equals( d, '/resource/server.xq?action=status', "OK" );
            }
         , error:    function(j,t,e) { ok(false, "NOK") }
         , complete: function()      { start(); } }) }) ;
      asyncTest("Change static to /public/", function() {
         $.ajax( {
           url: rewriteUrl( 'GET', '/css/style.css', 
             '<root>server#status</root>', '',
             '<staticDirectory>/public/</staticDirectory>' )
         , success:  function(d,t,j) { 
           equals( d, '/public/css/style.css', "OK" );
            }
         , error:    function(j,t,e) { ok(false, "NOK") }
         , complete: function()      { start(); } }) }) ;
    }) ;

    </script>
  </head>
  <body>
    <h1 id="qunit-header">rewrite tests</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
  </body>
</html>