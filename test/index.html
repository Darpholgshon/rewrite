<html>
  <head>
    <title>rewrite tests</title>
    <script src="static/jquery.js"></script>
    <link rel="stylesheet" 
      href="static/qunit.css" type="text/css" media="screen" />
    <script type="text/javascript"
      src="static/qunit.js"></script>
    <script type="text/javascript"
      src="static/rewrite-tests.js"></script>
    <script>
    $(document).ready(function(){
      module("root") ;
      asyncTest("simple root", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/', '<root>server#status</root>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/server.xqy?action=status', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("shouldn't match root", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/foo.jpg', 
            '<root>server#status</root>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/static/foo.jpg', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("root with arguments", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/?q=foo&foo=lander',
            '<root>store#search</root>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/store.xqy?action=search&q=foo&foo=lander',
            "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
        
      module("get") ;
      asyncTest("static get to", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/list', 
            '<get path="/list"> <to> article#list </to> </get>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/article.xqy?action=list', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
        
      module("put") ;
      asyncTest("static put to", function() {
        $.ajax( {
          url: rewriteUrl( 'PUT', '/upload', 
            '<put path="/upload"> <to> file#upload </to> </put>', '' )
        , type: 'PUT'
        , success:  function(d,t,j) { 
          equals( d, '/resource/file.xqy?action=upload', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      
      module("post") ;
      asyncTest("static post to", function() {
        $.ajax( {
          url: rewriteUrl( 'POST', '/upload', 
            '<post path="/upload"> <to> file#upload </to> </post>', '' )
        , type: 'POST'
        , success:  function(d,t,j) { 
          equals( d, '/resource/file.xqy?action=upload', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      
      module("delete") ;
      asyncTest("static delete to", function() {
        $.ajax( {
          url: rewriteUrl( 'DELETE', '/all-dbs', 
            '<delete path="/all-dbs"> <to> db#del </to> </delete>', '' )
        , type: 'DELETE'
        , success:  function(d,t,j) { 
          equals( d, '/resource/db.xqy?action=del', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      
      module("head") ;
      asyncTest("static head to", function() {
        $.ajax( {
          url: rewriteUrl( 'HEAD', '/', 
            '<head path="/"> <to> server#ping </to> </head>', '' )
        , type: 'GET' // head doesnt return body
        , success:  function(d,t,j) { 
          equals( d, '/resource/server.xqy?action=ping', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      
      module("resources") ;
      asyncTest("get", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/users/5', 
            '<resources name="users"/>', '' )
        , type: 'GET' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=get&id=5', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("index", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/users', 
            '<resources name="users"/>', '' )
        , type: 'GET' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=index', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("index with trailing slash", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/users/', 
            '<resources name="users"/>', '' )
        , type: 'GET' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=index', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("put", function() {
        $.ajax( {
          url: rewriteUrl( 'PUT', '/users/5', 
            '<resources name="users"/>', '' )
        , type: 'PUT' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=put&id=5', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("delete", function() {
        $.ajax( {
          url: rewriteUrl( 'DELETE', '/users/5', 
            '<resources name="users"/>', '' )
        , type: 'DELETE' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=delete&id=5', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("illegal post from webservice", function() {
        $.ajax( {
          url: rewriteUrl( 'POST', '/users', 
            '<resources name="users" webservice="true"/>', '' )
        , type: 'POST' 
        , success:  function(d,t,j) { 
          equals( d, '/static/users', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("post", function() {
        $.ajax( {
          url: rewriteUrl( 'POST', '/users', 
            '<resources name="users"/>', '' )
        , type: 'POST' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=post', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("new", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/users/new', 
            '<resources name="users"/>', '' )
        , type: 'GET' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=new', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("edit", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/users/5/edit', 
            '<resources name="users"/>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=edit&id=5', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("member include", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/users/5/enable', 
            '<resources name="users">'+
            '<member action="enable"/></resources>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=enable&id=5', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("include with multiple verbs", function() {
        $.ajax( {
          url: rewriteUrl( 'PUT', '/users/5/enable', 
            '<resources name="users">'+
            '<member action="enable" for="DELETE,PUT"/>'+
            '</resources>', '' )
        , type: 'PUT' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=enable&id=5', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("include with multiple verbs but none matches", function() {
        $.ajax( {
          url: rewriteUrl( 'PUT', '/users/5/enable', 
            '<resources name="users">'+
            '<member action="enable" for="DELETE,GET,POST"/>'+
            '</resources>', '' )
        , type: 'PUT' 
        , success:  function(d,t,j) { 
          notEqual( d, '/resource/users.xqy?action=enable&id=5', 
            "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("include set", function() {
        $.ajax( {
          url: rewriteUrl( 'PUT', '/users/notify', 
            '<resources name="users">'+
            '<set action="notify" for="PUT"/></resources>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=notify', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      
      module("resource") ;
      asyncTest("get", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/about', 
            '<resource name="about"/>', '' )
        , type: 'GET' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/about.xqy?action=get', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("put", function() {
        $.ajax( {
          url: rewriteUrl( 'PUT', '/ignition', 
            '<resource name="ignition"/>', '' )
        , type: 'PUT' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/ignition.xqy?action=put', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("delete", function() {
        $.ajax( {
          url: rewriteUrl( 'DELETE', '/ignition', 
            '<resource name="ignition"/>', '' )
        , type: 'DELETE' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/ignition.xqy?action=delete', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("illegal post from webservice", function() {
        $.ajax( {
          url: rewriteUrl( 'POST', '/about', 
            '<resource name="about" webservice="true"/>', '' )
        , type: 'POST' 
        , success:  function(d,t,j) { 
          equals( d, '/static/about', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("post", function() {
        $.ajax( {
          url: rewriteUrl( 'POST', '/about', 
            '<resource name="about"/>', '' )
        , type: 'POST' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/about.xqy?action=post', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("edit", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/about/edit', 
            '<resource name="about"/>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/about.xqy?action=edit', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("include", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/car/ignition', 
            '<resource name="car">'+
            '<member action="ignition"/></resource>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/car.xqy?action=ignition', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("include with multiple verbs", function() {
        $.ajax( {
          url: rewriteUrl( 'PUT', '/car/ignition', 
            '<resource name="car">'+
            '<member action="ignition" for="DELETE,PUT"/>'+
            '</resource>', '' )
        , type: 'PUT' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/car.xqy?action=ignition', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("include with multiple verbs but none matches", function() {
        $.ajax( {
          url: rewriteUrl( 'PUT', '/car/ignition', 
            '<resource name="car">'+
            '<memberInclude action="ignition" for="DELETE,GET,POST"/>'+
            '</resource>', '' )
        , type: 'PUT' 
        , success:  function(d,t,j) { 
          notEqual( d, '/resource/car.xqy?action=ignition', 
            "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;

      module("dynamic") ;
      asyncTest("search containing spaces", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/in love', 
            '<get path="/:q"> <to> story#search </to> </get>', '' )
        , type: 'GET' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/story.xqy?action=search&q=in+love', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("id using slashes", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/file//Some/File', 
            '<get path="/file/:id"> <to> file#get </to> </get>', '' )
        , type: 'GET' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/file.xqy?action=get&id=/Some/File', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("resource", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/Documents', 
            '<resource name=":database"/>', '' )
        , type: 'GET' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/database.xqy?action=get&database=Documents',
            "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;

      asyncTest("user id", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/user/43', 
            '<get path="/user/:id"> <to> user#show </to> </get>', '' )
        , type: 'GET' 
        , success:  function(d,t,j) { 
          equals( d, '/resource/user.xqy?action=show&id=43', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      
      module("complex") ;
      asyncTest("route should match with and without trailing /", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/list/', 
            '<get path="/list"> <to> article#list </to> </get>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/article.xqy?action=list', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("complex set include", function() {
        $.ajax( {
          url: rewriteUrl( 'PUT', '/users/notify', 
            '<resources name="users">'+
            '<set action="notify" for="PUT"/>'+
            '<member action="notify" for="GET,PUT"/>'+
            '</resources>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=notify', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("include", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/users/5/enable', 
            '<resources name="users">'+
            '<set action="enable"/>' +
            '<member action="enable"/></resources>', '' )
        , success:  function(d,t,j) { 
          equals( d, '/resource/users.xqy?action=enable&id=5', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
        
      module("paths") ;
      asyncTest("Change resource directory to /controller/", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/', '<root>server#status</root>', '',
          '<resourceDirectory>/controller/</resourceDirectory>' )
        , success:  function(d,t,j) { 
          equals( d, '/controller/server.xqy?action=status', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("Change resource directory to /", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/', '<root>server#status</root>', '',
          '<resourceDirectory>/</resourceDirectory>' )
        , success:  function(d,t,j) { 
          equals( d, '/server.xqy?action=status', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("Change resource directory to ()", function() {
        $.ajax( {
          url: rewriteUrl( 'GET', '/', '<root>server#status</root>', '',
          '<resourceDirectory/>' )
        , success:  function(d,t,j) { 
          equals( d, 'server.xqy?action=status', "OK" ); }
        , error:    function(j,t,e) { ok(false, "NOK") }
        , complete: function()      { start(); } }) }) ;
      asyncTest("Change extension to .xq", function() {
         $.ajax( {
           url: rewriteUrl( 'GET', '/', '<root>server#status</root>', '',
           '<xqyExtension>xq</xqyExtension>' )
         , success:  function(d,t,j) { 
           equals( d, '/resource/server.xq?action=status', "OK" ); }
         , error:    function(j,t,e) { ok(false, "NOK") }
         , complete: function()      { start(); } }) }) ;
      asyncTest("Change static to /public/", function() {
         $.ajax( {
           url: rewriteUrl( 'GET', '/css/style.css', 
             '<root>server#status</root>', '',
             '<staticDirectory>/public/</staticDirectory>' )
         , success:  function(d,t,j) { 
           equals( d, '/public/css/style.css', "OK" ); }
         , error:    function(j,t,e) { ok(false, "NOK") }
         , complete: function()      { start(); } }) }) ;
    }) ;

    </script>
  </head>
  <body>
    <h1 id="qunit-header">rewrite tests</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
  </body>
</html>